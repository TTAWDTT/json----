<!doctype html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>查看 {{ name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>pre{white-space:pre-wrap; max-height:60vh; overflow:auto;}</style>
  </head>
  <body>
    <nav class="navbar navbar-dark bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">JSON 管理</a>
      </div>
    </nav>

    <main class="container mt-4">
      <div class="row">
        <div class="col-md-8">
          <h3>{{ name }}</h3>
        </div>
        <div class="col-md-4 text-end">
          <a class="btn btn-outline-secondary" href="/raw/?name={{ name }}">下载完整文件</a>
          <button id="loadFull" class="btn btn-outline-primary">在页面加载完整文件</button>
        </div>
      </div>
      {% if message %}<div class="alert alert-info mt-3">{{ message }}</div>{% endif %}

      <div class="card mt-3">
        <div class="card-body">
          <form method="post" class="row g-2">
            <div class="col-auto">
              <input class="form-control" placeholder="字段名" name="field">
            </div>
            <div class="col">
              <input class="form-control" placeholder="替换值" name="value">
            </div>
            <div class="col-auto form-check align-self-center">
              <input class="form-check-input" type="checkbox" id="json_value" name="json_value">
              <label class="form-check-label" for="json_value">值为 JSON 字面量</label>
            </div>
            <div class="col-auto">
              <button class="btn btn-success" type="submit">替换并保存</button>
            </div>
          </form>

          {% if truncated %}
            <p class="mt-3 text-muted">文件较大，只显示前 200KB（可点击下载或在页面异步加载完整内容）</p>
          {% endif %}

          <pre class="mt-2" id="content">{{ content }}</pre>
        </div>
      </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      document.getElementById('loadFull')?.addEventListener('click', async function(){
        const btn = this; btn.disabled = true; btn.textContent = '加载中...';
        try{
          const res = await fetch(`/raw/?name={{ name }}`);
          if(!res.ok) throw new Error(res.status);
          const text = await res.text();
          document.getElementById('content').textContent = text;
        }catch(e){
          alert('加载失败: ' + e);
        } finally { btn.disabled=false; btn.textContent = '在页面加载完整文件' }
      });
    </script>
  </body>
</html>
