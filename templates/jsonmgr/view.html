<!doctype html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Êü•Áúã {{ name }}</title>
  <!-- Use Noto Sans SC for a clean square CJK sans-serif; fall back to system fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      pre{white-space:pre-wrap; max-height:60vh; overflow:auto;}
      /* enhanced JSON token styling: subtle colored chips + monospace */
      .json-pre{background:#f6f8fa;padding:12px;border-radius:8px;overflow:auto;font-family:Menlo,Monaco,Consolas,"Liberation Mono",monospace;font-size:13px;line-height:1.45}
      .json-key{color:#b31d28;font-weight:700;background:rgba(179,29,40,0.08);padding:0 6px;border-radius:4px}
      .json-string{color:#0b7a4b;background:rgba(11,122,75,0.06);padding:0 6px;border-radius:4px}
      .json-number{color:#1167b1;background:rgba(17,103,177,0.06);padding:0 6px;border-radius:4px}
      .json-boolean{color:#6f42c1;background:rgba(111,66,193,0.06);padding:0 6px;border-radius:4px}
      .json-null{color:#6a737d;background:rgba(106,115,125,0.06);padding:0 6px;border-radius:4px;font-style:italic}
      .json-error{color:#b31d28}
      /* small decorative left stripe per token line (gives a color impression for larger blocks) */
      .json-pre { box-shadow: inset 0 0 0 1px rgba(27,31,35,0.04); }
      /* filename styling: more 'square' Chinese font + purple background */
      .file-name {
        font-family: 'Noto Sans SC', "Microsoft YaHei", "PingFang SC", "Helvetica Neue", Arial, sans-serif;
        font-weight: 700;
        background: linear-gradient(180deg,#7b57c7 0%, #6f42c1 100%);
        color: #fff;
        display: inline-block;
        padding: 6px 12px;
        border-radius: 6px;
        box-shadow: 0 1px 0 rgba(0,0,0,0.06) inset;
        letter-spacing: 0.2px;
      }
  /* sidebar for document list */
  .doc-sidebar { position:fixed; left:0; top:0; bottom:0; width:260px; transform:translateX(-100%); background: #0f1720; color:#fff; z-index:1040; transition:transform .26s cubic-bezier(.2,.8,.2,1); box-shadow: 2px 0 12px rgba(0,0,0,0.4); will-change:transform; }
  .doc-sidebar.open { transform: translateX(0); }
  .doc-sidebar-inner { padding:12px; width:260px; overflow:auto; max-height:100vh; }
  .doc-sidebar .doc-link { color:#dbeafe; text-decoration:none; border-radius:6px; padding:6px 8px; display:block; margin-bottom:8px; border:1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.02); }
  .doc-sidebar .doc-link:hover { background: rgba(255,255,255,0.04); color:#fff }
  /* smooth expand for details-backed sections */
  .doc-sidebar details .details-content { max-height: 0; overflow: hidden; transition: max-height .26s cubic-bezier(.2,.8,.2,1); }
  .doc-sidebar details[open] .details-content { max-height: 600px; }
  .doc-sidebar details summary { cursor: pointer; }
  /* icons for items */
  .doc-sidebar .doc-link::before { content: "üìÑ"; margin-right:8px; display:inline-block; width:18px; text-align:center }
  .doc-sidebar details.backup-group > summary::before { content: "üìÅ"; margin-right:8px; display:inline-block; width:18px; text-align:center }
  .doc-sidebar details > summary::before { content: "üìÅ"; margin-right:8px; display:inline-block; width:18px; text-align:center }
  .doc-backdrop { position:fixed; inset:0; background: rgba(0,0,0,0.45); opacity:0; pointer-events:none; transition:opacity .22s ease; z-index:1030; }
  .doc-backdrop.show { opacity:1; pointer-events:auto; }
  body { padding-left: 0; }
  /* flat button backgrounds: make all buttons have a visible, flat background */
  .btn { box-shadow: none; border: none; border-radius: 6px; }
  .btn-outline-secondary, .btn-outline-primary { background-color: rgba(0,0,0,0.04); border: 1px solid rgba(0,0,0,0.08); color: inherit; }
  .btn-success { background-color: #198754; color: #fff; border: none; }
  /* smaller italic note used for truncated-file hint */
  .truncated-note { font-style: italic; font-size: 0.9rem; }
    </style>
  </head>
  <body>
    <!-- Â∑¶‰∏äËßíËèúÂçïÊåâÈíÆ‰∏é‰æßËæπÊ†èÔºàÊõø‰ª£ÂéüÊúâÈ°∂ÈÉ®ÂØºËà™Ôºâ -->
    <button id="menuToggle" class="btn btn-outline-secondary" aria-label="ÊâìÂºÄÊñáÊ°£ÂàóË°®" style="position:fixed;left:12px;top:12px;z-index:1050;border-radius:6px;padding:8px 10px;">‚ò∞</button>

    <div id="docSidebar" class="doc-sidebar" aria-hidden="true">
      <div class="doc-sidebar-inner">
        <div class="doc-sidebar-header d-flex justify-content-between align-items-center">
          <strong>ÊñáÊ°£ÂàóË°®</strong>
          <button id="closeSidebar" class="btn btn-sm btn-outline-secondary">ÂÖ≥Èó≠</button>
        </div>
        <div id="docList" class="doc-list mt-3">
          {% if files %}
            <div class="server-list">
              <ul class="list-unstyled mb-0">
                {% for f in files %}
                  <li><a class="doc-link" href="?name={{ f|urlencode }}">{{ f|cut:".json" }}</a></li>
                {% endfor %}
              </ul>
              {% if backups %}
                <details class="mt-2 backup-group">
                  <summary style="color:#fff">backups</summary>
                  <ul class="list-unstyled ps-3 mt-2 details-content">
                    {% for orig, blist in backups.items %}
                      <li>
              <details class="backup-group">
                <summary>{{ orig|cut:".json" }}</summary>
                          <ul class="list-unstyled ps-3 mt-1 details-content">
                            {% for b in blist %}
                              <li><a class="doc-link" href="?name={{ b|urlencode }}">{{ b }}</a></li>
                            {% endfor %}
                          </ul>
                        </details>
                      </li>
                    {% endfor %}
                  </ul>
                </details>
              {% endif %}
            </div>
          {% else %}
            <p class="text-muted">Êú™Êèê‰æõÊñá‰ª∂ÂàóË°®ÔºåÂèØÊâãÂä®ËæìÂÖ•Êñá‰ª∂ÂêçÊâìÂºÄÔºö</p>
            <div class="input-group mb-2">
              <input id="manualName" class="form-control" placeholder="ËæìÂÖ•Êñá‰ª∂ÂêçÔºå‰æãÂ¶Ç: test.json">
              <button id="goName" type="button" class="btn btn-primary">ÊâìÂºÄ</button>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <main class="container mt-4">
      <div class="row">
        <div class="col-md-8">
          <h3 class="file-name">{{ name }}</h3>
        </div>
        <div class="col-md-4 text-end">
          <a class="btn btn-outline-secondary" href="/raw/?name={{ name }}">‰∏ãËΩΩÂÆåÊï¥Êñá‰ª∂</a>
          <button id="loadFull" class="btn btn-outline-primary">Âú®È°µÈù¢Âä†ËΩΩÂÆåÊï¥Êñá‰ª∂</button>
        </div>
      </div>
      {% if message %}<div class="alert alert-info mt-3">{{ message }}</div>{% endif %}

      <div class="card mt-3">
        <div class="card-body">
          <form method="post" class="row g-2">
            <div class="col-auto">
              <input class="form-control" placeholder="Â≠óÊÆµÂêç" name="field">
            </div>
            <div class="col">
              <input class="form-control" placeholder="ÊõøÊç¢ÂÄº" name="value">
            </div>
            <div class="col-auto form-check align-self-center">
              <input class="form-check-input" type="checkbox" id="json_value" name="json_value">
              <label class="form-check-label" for="json_value">ÂÄº‰∏∫ JSON Â≠óÈù¢Èáè</label>
            </div>
            <div class="col-auto">
              <button class="btn btn-success" type="submit">ÊõøÊç¢Âπ∂‰øùÂ≠ò</button>
            </div>
          </form>

          {% if truncated %}
            <p class="mt-3 text-muted"><em class="truncated-note">Ê≥®ÔºöÊñá‰ª∂ËæÉÂ§ßÔºåÂè™ÊòæÁ§∫Ââç 200KBÔºàÂèØÁÇπÂáª‰∏ãËΩΩÊàñÂú®È°µÈù¢ÂºÇÊ≠•Âä†ËΩΩÂÆåÊï¥ÂÜÖÂÆπÔºâ</em></p>
          {% endif %}

          <div id="json-container" class="mt-2" data-truncated="{{ truncated|yesno:'true,false' }}"></div>
        </div>
      </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Simple syntax highlighter for JSON (keeps original JSON layout but adds colors)
      function escapeHtml(str) {
        return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      }

      // For full JSON: parse, pretty print then wrap tokens
      function highlightFullJSON(jsonText) {
        let pretty;
        try {
          const obj = JSON.parse(jsonText);
          pretty = JSON.stringify(obj, null, 2);
        } catch (e) {
          return `<span class="json-error">Êó†Ê≥ïËß£Êûê‰∏∫ JSON: ${escapeHtml(String(e))}</span>`;
        }
        let html = escapeHtml(pretty);
        // keys: "...":
        html = html.replace(/^(\s*)(\"([^\"]+)\")(?=\s*:)/gm, `$1<span class="json-key">$2</span>`);
        // strings
        html = html.replace(/\"([^\"]*)\"/g, `<span class="json-string">\"$1\"</span>`);
        // numbers
        html = html.replace(/\b(-?\d+(?:\.\d+)?(?:[eE][+-]?\d+)?)\b/g, `<span class="json-number">$1</span>`);
        // booleans
        html = html.replace(/\b(true|false)\b/g, `<span class="json-boolean">$1</span>`);
        // null
        html = html.replace(/\bnull\b/g, `<span class="json-null">null</span>`);
        return `<pre class="json-pre">${html}</pre>`;
      }

      // For truncated / partial content: do NOT JSON.parse; highlight tokens opportunistically
      function highlightPartialJSON(rawText) {
        const escaped = escapeHtml(rawText);
        let html = escaped;
        // highlight keys like "key": (only matches closed quotes)
        html = html.replace(/^(\s*)(\"([^\"]+)\")(?=\s*:)/gm, `$1<span class="json-key">$2</span>`);
        // highlight closed strings
        html = html.replace(/\"([^\"]*)\"/g, `<span class="json-string">\"$1\"</span>`);
        // numbers
        html = html.replace(/\b(-?\d+(?:\.\d+)?(?:[eE][+-]?\d+)?)\b/g, `<span class="json-number">$1</span>`);
        // booleans
        html = html.replace(/\b(true|false)\b/g, `<span class="json-boolean">$1</span>`);
        // null
        html = html.replace(/\bnull\b/g, `<span class="json-null">null</span>`);
        return `<pre class="json-pre">${html}</pre>`;
      }

      function tokenizeAndHighlight(text) {
        let out = '';
        const n = text.length;
        let i = 0;
        let inString = false;
        let esc = false;
        while (i < n) {
          const ch = text[i];
          if (inString) {
            // accumulate string content until unescaped quote
            let buf = '"';
            i++;
            while (i < n) {
              const c = text[i];
              if (c === '\\' && !esc) { esc = true; buf += c; i++; continue; }
              if (c === '"' && !esc) { buf += '"'; i++; break; }
              buf += c; esc = false; i++;
            }
            // decide if this string is a key (lookahead for colon)
            let j = i; while (j < n && /[\s\n\r\t]/.test(text[j])) j++;
            const isKey = (j < n && text[j] === ':');
            const cls = isKey ? 'json-key' : 'json-string';
            out += `<span class="${cls}">${escapeHtml(buf)}</span>`;
            inString = false;
            continue;
          }

          if (ch === '"') { inString = true; esc = false; continue; }

          // numbers
          if (/[-0-9]/.test(ch)) {
            let start = i; i++;
            while (i < n && /[0-9eE+\-.]/.test(text[i])) i++;
            const num = text.slice(start, i);
            out += `<span class="json-number">${escapeHtml(num)}</span>`;
            continue;
          }

          // literals true/false/null
          if (/[tfn]/.test(ch)) {
            let start = i; i++;
            while (i < n && /[a-zA-Z]/.test(text[i])) i++;
            const token = text.slice(start, i);
            if (token === 'true' || token === 'false') out += `<span class="json-boolean">${escapeHtml(token)}</span>`;
            else if (token === 'null') out += `<span class="json-null">${escapeHtml(token)}</span>`;
            else out += escapeHtml(token);
            continue;
          }

          // structural brackets/braces
          if (ch === '{' || ch === '}') { out += `<span class="json-brace json-brace-curly">${escapeHtml(ch)}</span>`; i++; continue; }
          if (ch === '[' || ch === ']') { out += `<span class="json-brace json-brace-square">${escapeHtml(ch)}</span>`; i++; continue; }

          // default: escape and emit single char
          out += escapeHtml(ch); i++;
        }
        return `<pre class="json-pre">${out}</pre>`;
      }

      // Create a collapsible node for a key/value pair
      function createNode(key, val) {
        const node = document.createElement('div');
        node.className = 'json-node mb-1';
        const isObject = val && typeof val === 'object';
        if (isObject) {
          const details = document.createElement('details');
          const summary = document.createElement('summary');
          const openSym = Array.isArray(val) ? '[' : '{';
          const closeSym = Array.isArray(val) ? ']' : '}';
          const braceClass = Array.isArray(val) ? 'json-brace-square' : 'json-brace-curly';
          summary.innerHTML = `<span class="json-brace ${braceClass}">${openSym}</span> <span class="json-key">\"${escapeHtml(String(key))}\"</span>: <span class="json-type text-muted">${Array.isArray(val)?'Array':'Object'}</span>`;
          details.appendChild(summary);
          const inner = document.createElement('div');
          inner.className = 'json-children ps-3';
          if (Array.isArray(val)) { val.forEach((v,i) => inner.appendChild(createNode(i, v))); }
          else { Object.keys(val).forEach(k => inner.appendChild(createNode(k, val[k]))); }
          details.appendChild(inner);
          const closing = document.createElement('div');
          closing.className = 'json-closing text-end';
          closing.innerHTML = `<span class="json-brace ${braceClass}">${closeSym}</span>`;
          details.appendChild(closing);
          node.appendChild(details);
        } else {
          // primitive
          let valHtml = '';
          if (typeof val === 'string') valHtml = `<span class="json-string">\"${escapeHtml(val)}\"</span>`;
          else if (typeof val === 'number') valHtml = `<span class="json-number">${val}</span>`;
          else if (typeof val === 'boolean') valHtml = `<span class="json-boolean">${val}</span>`;
          else if (val === null) valHtml = `<span class="json-null">null</span>`;
          else valHtml = escapeHtml(String(val));
          node.innerHTML = `<span class="json-key">\"${escapeHtml(String(key))}\"</span>: ${valHtml}`;
        }
        return node;
      }

      function renderJSONTree(container, obj) {
        container.innerHTML = '';
        if (Array.isArray(obj)) { obj.forEach((v,i) => container.appendChild(createNode(i, v))); }
        else if (obj && typeof obj === 'object') { Object.keys(obj).forEach(k => container.appendChild(createNode(k, obj[k]))); }
        else { container.innerHTML = tokenizeAndHighlight(JSON.stringify(obj)); }
      }

      // attach styles (blocky font + colored braces)
      (function(){
        const s = document.createElement('style');
        s.textContent = `
          /* overall JSON area: light blue background */
          .json-pre{background: linear-gradient(180deg,#e6f6ff 0%, #d8ecff 100%);padding:14px;border-radius:10px;overflow:auto;font-family:"Courier New",Menlo,Monaco,Consolas,"Liberation Mono",monospace;font-size:13px;line-height:1.45;color:#022041}
          /* tokens use semi-transparent white so they pop on blue */
          .json-key{color:#b31d28;font-weight:700;background:rgba(255,255,255,0.16);padding:0 6px;border-radius:4px}
          .json-string{color:#064d2b;background:rgba(255,255,255,0.10);padding:0 6px;border-radius:4px}
          .json-number{color:#083f7a;background:rgba(255,255,255,0.10);padding:0 6px;border-radius:4px}
          .json-boolean{color:#4b2fa6;background:rgba(255,255,255,0.10);padding:0 6px;border-radius:4px}
          .json-null{color:#37474f;background:rgba(255,255,255,0.10);padding:0 6px;border-radius:4px;font-style:italic}
          .json-error{color:#7a1720}
          /* curly braces: highlight blue */
          .json-brace-curly{color:#0b5fff;font-weight:700}
          /* square brackets: highlight yellow */
          .json-brace-square{color:#ffb84d;font-weight:700}
          .json-pre { box-shadow: inset 0 0 0 1px rgba(3,27,65,0.04); }
          /* flat button backgrounds to match page theme */
          .btn { box-shadow: none; border: none; border-radius: 6px; }
          .btn-outline-secondary, .btn-outline-primary { background-color: rgba(0,0,0,0.04); border: 1px solid rgba(0,0,0,0.08); color: inherit; }
          .btn-success { background-color: #198754; color: #fff; border: none; }
        `;
        document.head.appendChild(s);
      })();

      function init() {
        const raw = `{{ content|escapejs }}`;
        const container = document.getElementById('json-container');
        const truncated = container?.dataset.truncated === 'true';
        if (raw) {
          if (truncated) container.innerHTML = tokenizeAndHighlight(raw);
          else {
            // for full content, pretty-print first to get nice indentation
            try {
              const obj = JSON.parse(raw);
              const pretty = JSON.stringify(obj, null, 2);
              container.innerHTML = tokenizeAndHighlight(pretty);
            } catch (e) {
              container.innerHTML = `<span class="json-error">Êó†Ê≥ïËß£Êûê‰∏∫ JSON: ${escapeHtml(String(e))}</span>`;
            }
          }
        }
      }
      init();

      document.getElementById('loadFull')?.addEventListener('click', async function(){
        const btn = this;
        btn.disabled = true;
        btn.textContent = 'Âä†ËΩΩ‰∏≠...';
        try {
          const res = await fetch(`/raw/?name={{ name }}`);
          if (!res.ok) throw new Error(res.status);
          const text = await res.text();
          try {
            const obj = JSON.parse(text);
            const pretty = JSON.stringify(obj, null, 2);
            document.getElementById('json-container').innerHTML = tokenizeAndHighlight(pretty);
          } catch (e) {
            // fallback: partial highlight of raw text
            document.getElementById('json-container').innerHTML = tokenizeAndHighlight(text);
          }
        } catch (e) {
          alert('Âä†ËΩΩÂ§±Ë¥•: ' + e);
        } finally {
          btn.disabled = false;
          btn.textContent = 'Âú®È°µÈù¢Âä†ËΩΩÂÆåÊï¥Êñá‰ª∂';
        }
      });

      // Sidebar toggle and navigation handlers
      (function(){
        const menu = document.getElementById('menuToggle');
        const sidebar = document.getElementById('docSidebar');
        const closeBtn = document.getElementById('closeSidebar');
        const goBtn = document.getElementById('goName');
        const manual = document.getElementById('manualName');

        // create backdrop
        let backdrop = document.querySelector('.doc-backdrop');
        if (!backdrop) {
          backdrop = document.createElement('div');
          backdrop.className = 'doc-backdrop';
          document.body.appendChild(backdrop);
        }

        function shortName(fn){
          return fn.endsWith('.json') ? fn.slice(0, -5) : fn;
        }

        function renderList(data){
          const listWrap = document.createElement('div');
          // files
          const ul = document.createElement('ul'); ul.className='list-unstyled mb-2';
          (data.files||data||[]).forEach(f => {
            const li = document.createElement('li');
            const a = document.createElement('a');
            a.className = 'doc-link d-block py-1';
            a.href = `?name=${encodeURIComponent(f)}`;
            a.textContent = shortName(f);
            li.appendChild(a);
            ul.appendChild(li);
          });
          listWrap.appendChild(ul);
          // backups grouped
          if (data.backups && Object.keys(data.backups).length){
            const bwrap = document.createElement('div');
            bwrap.className = 'mt-2';
            const title = document.createElement('strong'); title.textContent = 'backups';
            bwrap.appendChild(title);
              Object.keys(data.backups).forEach(orig => {
              const details = document.createElement('details'); details.className='backup-group';
              const summary = document.createElement('summary');
              summary.textContent = shortName(orig);
              details.appendChild(summary);
              const bul = document.createElement('ul'); bul.className='list-unstyled ps-3 details-content';
              (data.backups[orig]||[]).forEach(b => {
                const bli = document.createElement('li');
                const ba = document.createElement('a'); ba.className='doc-link d-block py-1'; ba.href=`?name=${encodeURIComponent(b)}`; ba.textContent = b;
                bli.appendChild(ba); bul.appendChild(bli);
              });
              details.appendChild(bul);
              bwrap.appendChild(details);
            });
            listWrap.appendChild(bwrap);
          }
          const docList = document.getElementById('docList');
          // clear existing content (keep manual input if present when no data.files)
          docList.innerHTML = '';
          docList.appendChild(listWrap);
          // setup smooth details animation after inserting
          setupDetailsAnimation();
        }

        async function fetchFileList(){
          const docList = document.getElementById('docList');
          // if server already rendered links, do nothing
          if (docList.querySelector('.doc-link')) return;
          const endpoints = ['/api/files','/files','/list-files','/json/files','/files.json'];
          // show loading hint
          const hint = document.createElement('div'); hint.className='text-muted'; hint.textContent='Ê≠£Âú®Â∞ùËØïËé∑ÂèñÊñáÊ°£ÂàóË°®‚Ä¶';
          docList.appendChild(hint);
      for (const ep of endpoints){
            try {
              const res = await fetch(ep, { headers:{ 'Accept':'application/json' } });
              if (!res.ok) continue;
        const data = await res.json();
        // support both array or structured {files,backups}
        if (Array.isArray(data) && data.length){ renderList({files:data, backups:{}}); return; }
        if (data && (data.files || data.backups)) { renderList(data); return; }
            } catch (e) { /* ignore and try next */ }
          }
          // nothing found: show friendly fallback (keep manual input if any)
          docList.innerHTML = '';
          const p = document.createElement('p'); p.className='text-muted'; p.textContent='Êú™ËÉΩËá™Âä®Ëé∑ÂèñÊñáÊ°£ÂàóË°®ÔºåËØ∑Á°ÆËÆ§ÂêéÁ´Ø‰º†ÂÖ•Ê®°ÊùøÂèòÈáè `files` Êàñ‰ΩøÁî®‰∏ãÊñπÊâãÂä®ËæìÂÖ•„ÄÇ';
          docList.appendChild(p);
        }

        // smooth details animation using measured height
        function setupDetailsAnimation(){
          // Robust nested-details animation.
          // On open: animate to measured px height then clear to 'none' after transition.
          // On close: if currently 'none', fix to current px then animate to 0.
          document.querySelectorAll('.doc-sidebar details').forEach(d => {
            const content = d.querySelector('.details-content');
            if (!content) return;
            content.style.transition = 'max-height .26s cubic-bezier(.2,.8,.2,1)';
            content.style.overflow = 'hidden';

            const updateAncestorHeights = () => {
              let p = d.parentElement;
              while (p) {
                if (p.tagName && p.tagName.toLowerCase() === 'details') {
                  const pc = p.querySelector('.details-content');
                  if (pc && pc.style.maxHeight !== 'none') pc.style.maxHeight = pc.scrollHeight + 'px';
                }
                p = p.parentElement;
              }
            };

            const onToggle = () => {
              if (d.open) {
                content.style.maxHeight = content.scrollHeight + 'px';
                const onEnd = (ev) => {
                  if (ev.propertyName === 'max-height') {
                    if (d.open) {
                      content.style.maxHeight = 'none';
                      // also clear ancestor inline maxHeights shortly after so they can resize to new content
                      setTimeout(()=>{
                        let p = d.parentElement;
                        while (p) {
                          if (p.tagName && p.tagName.toLowerCase() === 'details') {
                            const pc = p.querySelector('.details-content');
                            if (pc) pc.style.maxHeight = 'none';
                          }
                          p = p.parentElement;
                        }
                      }, 40);
                    }
                    content.removeEventListener('transitionend', onEnd);
                  }
                };
                content.addEventListener('transitionend', onEnd);
                updateAncestorHeights();
              } else {
                if (content.style.maxHeight === 'none' || content.style.maxHeight === '') {
                  content.style.maxHeight = content.scrollHeight + 'px';
                  void content.offsetHeight; // force reflow
                }
                content.style.maxHeight = '0px';
                updateAncestorHeights();
              }
            };

            if (d._detailToggleHandler) d.removeEventListener('toggle', d._detailToggleHandler);
            d._detailToggleHandler = onToggle;
            d.addEventListener('toggle', onToggle);

            if (d.open) {
              content.style.maxHeight = content.scrollHeight + 'px';
              setTimeout(()=>{ if (d.open) content.style.maxHeight = 'none'; }, 300);
            } else {
              content.style.maxHeight = '0px';
            }
          });
    }

  function openSidebar(){
          sidebar.classList.add('open');
          sidebar.setAttribute('aria-hidden','false');
          backdrop.classList.add('show');
          menu.style.opacity = '0';
          menu.style.pointerEvents = 'none';
          // attempt to fetch list if none rendered
          fetchFileList().catch(()=>{});
        }
        function closeSidebar(){
          sidebar.classList.remove('open');
          sidebar.setAttribute('aria-hidden','true');
          backdrop.classList.remove('show');
          menu.style.opacity = '';
          menu.style.pointerEvents = '';
        }

        menu?.addEventListener('click', function(){
          if (sidebar.classList.contains('open')) closeSidebar(); else openSidebar();
        });
        closeBtn?.addEventListener('click', closeSidebar);
        backdrop?.addEventListener('click', closeSidebar);

  if (goBtn && manual) {
          goBtn.addEventListener('click', function(){
            const v = manual.value && manual.value.trim();
            if (!v) return alert('ËØ∑ËæìÂÖ•Êñá‰ª∂Âêç');
            const q = new URLSearchParams(window.location.search);
            q.set('name', v);
            window.location.search = q.toString();
          });
        }
        // intercept doc-link clicks: close sidebar smoothly then navigate
        document.addEventListener('click', function(e){
          const a = e.target.closest && e.target.closest('.doc-link');
          if (!a) return;
          e.preventDefault();
          const href = a.getAttribute('href');
          closeSidebar();
          setTimeout(()=>{ window.location.href = href; }, 260);
        });
  // ensure server-rendered details are initialized for smooth animation
  setupDetailsAnimation();
      })();
    </script>
  </body>
</html>
